name: Keep HuggingFace Space Alive with Email + WeChat Alert

on:
  schedule:
    - cron: "*/10 * * * *"  # æ¯10åˆ†é’Ÿè¿è¡Œä¸€æ¬¡
  workflow_dispatch:

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Mask URL in logs
        run: echo "::add-mask::${{ secrets.SPACE_URL }}"

      - name: Curl HuggingFace Space
        id: ping
        run: |
          if curl -s --fail "${{ secrets.SPACE_URL }}" > /dev/null; then
            echo "status=ok" >> $GITHUB_OUTPUT
          else
            echo "status=fail" >> $GITHUB_OUTPUT
          fi

      # é‚®ä»¶æé†’
      - name: Send Email if Failed
        if: steps.ping.outputs.status == 'fail'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.office365.com   # å¦‚æœç”¨ Gmail æ”¹æˆ smtp.gmail.com
          server_port: 587
          secure: true
          username: ${{ secrets.MAIL_USER }}
          password: ${{ secrets.MAIL_PASS }}
          subject: "ğŸš¨ Hugging Face Space ä¿æ´»å¤±è´¥"
          to: zqc@158844.onmicrosoft.com,zqc2911445418@outlook.com,swanedward77@gmail.com
          from: ${{ secrets.MAIL_USER }}
          body: |
            è­¦å‘Šï¼š${{ secrets.SPACE_URL }} ä¿æ´»æ£€æµ‹å¤±è´¥ï¼Œè¯·ç«‹å³æ£€æŸ¥ Space çŠ¶æ€ã€‚

      # å¾®ä¿¡æé†’
      - name: Send WeChat Alert if Failed
        if: steps.ping.outputs.status == 'fail'
        run: |
          curl -s "https://sctapi.ftqq.com/${{ secrets.SERVERCHAN_KEY }}.send" \
          -d "title=ğŸš¨ Hugging Face Space ä¿æ´»å¤±è´¥" \
          -d "desp=æ£€æµ‹åˆ° ${{ secrets.SPACE_URL }} ä¿æ´»å¤±è´¥ï¼Œè¯·ç«‹å³æ£€æŸ¥ã€‚"
